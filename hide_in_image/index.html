<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>隐写术工具 - 框选与像素矩阵</title>
  <style>
    /* 全局样式 */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overscroll-behavior: none;
    }

    h1 {
      color: #444;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    /* 容器布局 */
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 98%; /* 增加宽度利用率 */
      max-width: 1600px; /* 允许更宽的显示 */
      margin: 10px auto;
      padding: 10px;
      background-color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    .instructions {
      text-align: left;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
    }

    .instructions h4 {
      text-align: center;
      margin: 0;
      font-weight: normal;
    }

    .top-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .file-input {
      margin-bottom: 15px;
      width: 100%;
      text-align: center;
    }

    .file-input input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      transition: border-color 0.3s;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }

    .canvas-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      overflow: hidden;
      user-select: none;
      touch-action: none;
      background-color: #eee;
      border-radius: 8px;
    }

    canvas {
      border: 1px solid #888;
      cursor: crosshair;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 100%;
      height: auto;
      display: block;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 15px 0;
      gap: 8px;
      width: 100%;
    }

    .controls button {
      padding: 12px 10px;
      font-size: 13px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      flex: 1 0 45%;
      max-width: 150px;
    }

    .controls button:active:not(:disabled) {
      transform: scale(0.98);
    }

    .controls button:disabled {
      background-color: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }

    #clearLsb { background-color: #ff9800; color: white; }
    #addOneBtn { background-color: #4caf50; color: white; }
    #highlightOddBtn { background-color: #9c27b0; color: white; }
    #saveChangesBtn { background-color: #2196f3; color: white; }
    #clearSelection { background-color: #f44336; color: white; }

    /* --- 像素矩阵样式 --- */
    .matrix-section {
      width: 100%;
      position: relative;
    }

    .matrix-section h2 {
      margin-bottom: 10px;
      text-align: center;
      font-size: 1.2rem;
    }

    .matrix-container {
      width: 100%;
      touch-action: none; 
    }

    .matrix {
      display: grid;
      gap: 0;
      margin: 0 auto;
      user-select: none;
      width: 100%;
      background-color: #ccc;
      border: 1px solid #ccc;
    }

    .matrix div {
      background: #ffffff;
      text-align: center;
      cursor: pointer;
      box-sizing: border-box;
      border: 0.5px solid #ddd;
      
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      
      aspect-ratio: 1 / 1; 
      position: relative;
      overflow: hidden;
      padding: 0;
    }

    .matrix div .content-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .matrix div span {
      display: block;
      white-space: nowrap;
      font-family: 'Arial Narrow', sans-serif;
      font-weight: 500;
      color: #333; /* 默认文字颜色 */
    }

    /* --- 密度适配 --- */
    
    /* 默认/低密度 */
    .matrix div span {
        font-size: 11px;
        line-height: 1.2;
    }

    /* 中等密度 (>12列) */
    .matrix.medium-density div span {
        font-size: 10px;
        line-height: 1;
        letter-spacing: -0.5px;
    }

    /* 高密度 (>25列) */
    .matrix.high-density div .content-wrapper {
        transform: scale(0.9);
        width: 111%;
        height: 111%;
        margin-left: -5.5%;
        margin-top: -5.5%;
    }
    .matrix.high-density div span {
        font-size: 10px;
        line-height: 0.9;
        letter-spacing: -1px;
    }
    
    /* 超高密度 (>40列) */
    .matrix.super-density div .content-wrapper {
        transform: scale(0.65);
        transform-origin: center center;
        width: 154%; 
        height: 154%;
        margin-left: -27%;
        margin-top: -27%;
    }

    .matrix.super-density div span {
        font-size: 12px; 
        line-height: 0.85; 
        letter-spacing: -1px;
        font-weight: bold;
    }

    /* --- 选中和交互样式 (加深背景色，保持黑色文字) --- */
    
    /* 1. 选中状态：蓝色背景 (加深) */
    .matrix div.selected {
      background-color: #64b5f6 !important; /* 蓝色 */
      border-color: #2196f3 !important;
    }
    /* 保持文字黑色 */
    .matrix div.selected .content-wrapper span,
    .matrix div.selected span {
        color: #000 !important; 
        font-weight: bold;
    }

    /* 2. 奇数高亮状态：红色背景 (加深) */
    .matrix div.odd {
      background-color: #e57373 !important; /* 红色 */
      border-color: #f44336 !important;
    }
    /* 保持文字黑色 */
    .matrix div.odd .content-wrapper span,
    .matrix div.odd span {
        color: #000 !important;
        font-weight: bold;
    }

    /* 3. 同时选中且为奇数：紫色背景 (加深) */
    .matrix div.selected.odd {
      background-color: #ba68c8 !important; /* 紫色 */
      border-color: #9c27b0 !important;
    }

    /* 放大镜样式 */
    #magnifier {
        position: fixed;
        display: none;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        pointer-events: none;
        z-index: 2000;
        font-size: 13px;
        font-family: monospace;
        line-height: 1.5;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        min-width: 100px;
        white-space: nowrap;
    }

    #magnifier .color-preview {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 1px solid #fff;
        margin-right: 8px;
        vertical-align: -2px;
    }

    /* 响应式设计 */
    @media (max-width: 600px) {
      .container {
        padding: 5px;
      }
      .controls button {
        flex: 1 0 40%;
      }
      .matrix.super-density div .content-wrapper {
          transform: scale(0.5); 
          width: 200%;
          height: 200%;
          margin-left: -50%;
          margin-top: -50%;
      }
    }
  </style>
</head>
<body>
  <h1>图里藏着什么秘密？</h1>
  <div class="container">
    <div class="instructions">
      <h4>提示：图片中框选位置后，会出现像素值矩阵。点击或滑动选择像素点。</h4>
    </div>

    <div class="top-section">
      <div class="file-input">
        <input type="file" id="imageInput" accept="image/*">
      </div>
      <div class="canvas-container">
        <canvas id="canvas" width="600" height="400"></canvas>
      </div>
    </div>

    <div class="controls">
      <button id="clearLsb" disabled>末位清零</button>
      <button id="addOneBtn" disabled>选中像素加1</button>
      <button id="highlightOddBtn" disabled>奇数高亮</button>
      <button id="saveChangesBtn" disabled>保存修改</button>
      <button id="clearSelection" disabled>清除选择</button>
    </div>

    <div class="matrix-section">
      <h2>框选区域的像素矩阵</h2>
      <div class="matrix-container" id="matrixContainer">
        <div id="matrix" class="matrix"></div>
      </div>
    </div>
  </div>

  <div id="magnifier"></div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const imageInput = document.getElementById("imageInput");
    const matrixContainer = document.getElementById("matrix");
    const clearLsbBtn = document.getElementById("clearLsb");
    const addOneBtn = document.getElementById("addOneBtn");
    const saveChangesBtn = document.getElementById("saveChangesBtn");
    const clearSelectionBtn = document.getElementById("clearSelection");
    const highlightOddBtn = document.getElementById("highlightOddBtn");
    const magnifier = document.getElementById("magnifier");

    let imageData = null;
    let selection = null;
    let isSelecting = false;
    let startX, startY;
    let selectedCells = new Set();
    
    let isPainting = false; 
    let paintTargetState = true; 
    let lastPaintedIndex = -1; 

    const MAX_SELECTION_SIZE = 50; 

    function loadImage(src) {
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        imageData = ctx.getImageData(0, 0, img.width, img.height);
        resetUI();
      };
      img.onerror = () => {
        console.log("Default image not found.");
      };
      img.src = src;
    }

    function resetUI() {
        clearLsbBtn.disabled = false;
        saveChangesBtn.disabled = true;
        clearSelectionBtn.disabled = true;
        addOneBtn.disabled = true;
        highlightOddBtn.disabled = true;
        matrixContainer.innerHTML = "";
        selectedCells.clear();
        selection = null;
    }

    window.addEventListener("load", () => {
      loadImage('tree.png');
    });

    imageInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        loadImage(e.target.result);
      };
      reader.readAsDataURL(file);
    });

    clearLsbBtn.addEventListener("click", () => {
      if (!imageData) return;
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
          data[i] = data[i] & 0xFE;         
          data[i + 1] = data[i + 1] & 0xFE; 
          data[i + 2] = data[i + 2] & 0xFE; 
      }
      ctx.putImageData(imageData, 0, 0);
      alert("末位清零完成！");
      if (selection) {
          showMatrix(); 
      }
      saveChangesBtn.disabled = false;
    });

    canvas.addEventListener("pointerdown", (event) => {
      if (!imageData || !event.isPrimary) return;
      
      event.preventDefault(); 
      canvas.setPointerCapture(event.pointerId);
      isSelecting = true;
      
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

      startX = (event.clientX - rect.left) * scaleX;
      startY = (event.clientY - rect.top) * scaleY;
      
      selection = null;
      selectedCells.clear();
      addOneBtn.disabled = true;
      highlightOddBtn.disabled = true;
      clearSelectionBtn.disabled = true;
      
      ctx.putImageData(imageData, 0, 0);
      matrixContainer.innerHTML = ""; 
    });

    canvas.addEventListener("pointermove", (event) => {
      if (!isSelecting || !imageData) return;
      event.preventDefault(); 
      
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

      let endX = (event.clientX - rect.left) * scaleX;
      let endY = (event.clientY - rect.top) * scaleY;

      let width = Math.abs(endX - startX);
      let height = Math.abs(endY - startY);

      if (width > MAX_SELECTION_SIZE) {
        width = MAX_SELECTION_SIZE;
        endX = startX + (endX > startX ? MAX_SELECTION_SIZE : -MAX_SELECTION_SIZE);
      }
      if (height > MAX_SELECTION_SIZE) {
        height = MAX_SELECTION_SIZE;
        endY = startY + (endY > startY ? MAX_SELECTION_SIZE : -MAX_SELECTION_SIZE);
      }

      const maxX = imageData.width;
      const maxY = imageData.height;
      const x1 = Math.floor(Math.max(0, Math.min(Math.min(startX, endX), maxX)));
      const y1 = Math.floor(Math.max(0, Math.min(Math.min(startY, endY), maxY)));
      const x2 = Math.floor(Math.max(0, Math.min(Math.max(startX, endX), maxX)));
      const y2 = Math.floor(Math.max(0, Math.min(Math.max(startY, endY), maxY)));

      selection = { x1, y1, x2, y2 };
      drawSelection();
    });

    canvas.addEventListener("pointerup", (event) => {
      if (!isSelecting) return;
      canvas.releasePointerCapture(event.pointerId);
      isSelecting = false;
      
      if (selection && (selection.x2 - selection.x1 > 0) && (selection.y2 - selection.y1 > 0)) {
        showMatrix();
        clearSelectionBtn.disabled = false;
        addOneBtn.disabled = false;
        highlightOddBtn.disabled = false;
        if (window.innerWidth <= 600) {
            matrixContainer.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      } else {
        selection = null;
        ctx.putImageData(imageData, 0, 0);
        matrixContainer.innerHTML = "<div style='padding:20px; color:#666; font-size:14px;'>请拖拽框选一个区域。</div>";
      }
    });

    function drawSelection() {
      ctx.putImageData(imageData, 0, 0);
      if (selection) {
        ctx.strokeStyle = "#ff0000";
        ctx.lineWidth = 1; 
        ctx.strokeRect(
          selection.x1 + 0.5, 
          selection.y1 + 0.5,
          selection.x2 - selection.x1,
          selection.y2 - selection.y1
        );

        ctx.fillStyle = "rgba(255, 0, 0, 0.15)";
        ctx.fillRect(
          selection.x1,
          selection.y1,
          selection.x2 - selection.x1,
          selection.y2 - selection.y1
        );
      }
    }

    function showMatrix() {
      if (!selection || !imageData) return;

      const { x1, y1, x2, y2 } = selection;
      const width = imageData.width;
      const data = imageData.data;

      matrixContainer.innerHTML = "";
      
      const columns = x2 - x1;
      const rows = y2 - y1;
      const totalCells = columns * rows;
      
      if (totalCells > 10000) {
          matrixContainer.innerHTML = "<div style='padding:20px; color:red;'>选择区域过大。</div>";
          return;
      }

      matrixContainer.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
      
      matrixContainer.classList.remove('medium-density', 'high-density', 'super-density');

      if (columns > 40) {
        matrixContainer.classList.add('super-density'); 
      } else if (columns > 25) {
        matrixContainer.classList.add('high-density'); 
      } else if (columns > 12) {
        matrixContainer.classList.add('medium-density'); 
      }

      const fragment = document.createDocumentFragment();

      for (let y = y1; y < y2; y++) {
        for (let x = x1; x < x2; x++) {
          const index = (y * width + x) * 4;
          const r = data[index];
          const g = data[index + 1];
          const b = data[index + 2];

          const div = document.createElement("div");
          
          div.innerHTML = `
            <div class="content-wrapper">
                <span>R:${r}</span>
                <span>G:${g}</span>
                <span>B:${b}</span>
            </div>
          `;

          div.dataset.index = index;
          div.dataset.r = r;
          div.dataset.g = g;
          div.dataset.b = b;
          div.dataset.x = x;
          div.dataset.y = y;
          div.classList.add('matrix-cell');
          
          fragment.appendChild(div);
        }
      }
      matrixContainer.appendChild(fragment);
    }
    
    matrixContainer.addEventListener("pointerdown", (e) => {
        const target = e.target.closest('.matrix-cell');
        if (!target) return;

        e.preventDefault(); 
        
        isPainting = true;
        const index = parseInt(target.dataset.index);
        
        if (selectedCells.has(index)) {
            paintTargetState = false; 
        } else {
            paintTargetState = true; 
        }
        
        lastPaintedIndex = -1; 
        applyPaint(target); 
        
        showMagnifier(e, target.dataset.r, target.dataset.g, target.dataset.b, target.dataset.x, target.dataset.y);
    });

    window.addEventListener("pointermove", (e) => {
        if (!isPainting) {
            if (e.pointerType === 'mouse') {
                const target = e.target.closest('.matrix-cell');
                if (target) {
                    showMagnifier(e, target.dataset.r, target.dataset.g, target.dataset.b, target.dataset.x, target.dataset.y);
                    return;
                }
            }
            hideMagnifier();
            return;
        }

        e.preventDefault();

        const targetElement = document.elementFromPoint(e.clientX, e.clientY);
        if (targetElement) {
            const targetCell = targetElement.closest('.matrix-cell');
            if (targetCell) {
                applyPaint(targetCell);
                showMagnifier(e, targetCell.dataset.r, targetCell.dataset.g, targetCell.dataset.b, targetCell.dataset.x, targetCell.dataset.y);
            }
        }
        
        updateMagnifierPosition(e);
    }, { passive: false });

    window.addEventListener("pointerup", () => {
        isPainting = false;
        lastPaintedIndex = -1;
        hideMagnifier();
    });
    
    window.addEventListener("pointercancel", () => {
        isPainting = false;
        hideMagnifier();
    });

    function applyPaint(cell) {
        const index = parseInt(cell.dataset.index);
        
        if (index === lastPaintedIndex) return;
        
        lastPaintedIndex = index;
        
        if (paintTargetState) {
            if (!selectedCells.has(index)) {
                selectedCells.add(index);
                cell.classList.add("selected");
            }
        } else {
            if (selectedCells.has(index)) {
                selectedCells.delete(index);
                cell.classList.remove("selected");
            }
        }
    }

    function showMagnifier(e, r, g, b, x, y) {
        if (r === undefined) return;
        const colorPreview = `<span class="color-preview" style="background-color: rgb(${r},${g},${b})"></span>`;
        magnifier.innerHTML = `
            <strong>Pos: (${x}, ${y})</strong><br>
            ${colorPreview} R: ${r}<br>
            ${colorPreview} G: ${g}<br>
            ${colorPreview} B: ${b}
        `;
        magnifier.style.display = 'block';
        updateMagnifierPosition(e);
    }
    
    function updateMagnifierPosition(e) {
        const x = e.clientX;
        const y = e.clientY;
        
        const isMobile = window.innerWidth <= 600;
        
        let targetX = x + 20;
        let targetY = y + 20;
        
        if (isMobile) {
            targetX = x - 50; 
            targetY = y - 110; 
            
            if (targetY < 10) targetY = y + 30; 
        }
        
        const maxX = window.innerWidth - 120;
        if (targetX > maxX) targetX = maxX;
        if (targetX < 10) targetX = 10;
        
        magnifier.style.left = targetX + 'px';
        magnifier.style.top = targetY + 'px';
    }
    
    function hideMagnifier() {
        magnifier.style.display = 'none';
    }

    clearSelectionBtn.addEventListener("click", () => {
      selectedCells.clear();
      const divs = matrixContainer.querySelectorAll('div.selected');
      divs.forEach(div => div.classList.remove('selected'));
      hideMagnifier();
    });
    
    window.addEventListener("pointerup", () => {
      isSelecting = false;
    });

    addOneBtn.addEventListener("click", () => {
      if (!imageData || selectedCells.size === 0) {
          alert("请先在矩阵中选择像素点");
          return;
      }
      const data = imageData.data;
      
      selectedCells.forEach(index => {
        data[index] = (data[index] + 1) % 256;
        data[index + 1] = (data[index + 1] + 1) % 256;
        data[index + 2] = (data[index + 2] + 1) % 256;
        
        const div = matrixContainer.querySelector(`div[data-index='${index}']`);
        if (div) {
            const r = data[index];
            const g = data[index + 1];
            const b = data[index + 2];
            
            div.dataset.r = r;
            div.dataset.g = g;
            div.dataset.b = b;
            
            div.querySelector('.content-wrapper').innerHTML = `
                <span>R:${r}</span>
                <span>G:${g}</span>
                <span>B:${b}</span>
            `;
        }
      });
      
      ctx.putImageData(imageData, 0, 0);
      alert("选中的像素已加1！");
      saveChangesBtn.disabled = false;
    });

    highlightOddBtn.addEventListener("click", () => {
      if (!imageData || !selection) return;
      const { x1, y1, x2, y2 } = selection;
      const width = imageData.width;
      const data = imageData.data;

      const divs = matrixContainer.querySelectorAll('div');
      divs.forEach(div => {
        div.classList.remove('odd');
      });
      
      let found = false;
      for (let y = y1; y < y2; y++) {
        for (let x = x1; x < x2; x++) {
          const index = (y * width + x) * 4;
          const r = data[index];
          const g = data[index + 1];
          const b = data[index + 2];
          if (r % 2 === 1 && g % 2 === 1 && b % 2 === 1) {
            const div = matrixContainer.querySelector(`div[data-index='${index}']`);
            if (div) {
              div.classList.add('odd');
              found = true;
            }
          }
        }
      }
      if(!found) {
          alert("选区内没有符合 RGB 均为奇数的像素点。");
      }
    });

    saveChangesBtn.addEventListener("click", () => {
      if (!imageData) return;
      ctx.putImageData(imageData, 0, 0);

      const link = document.createElement('a');
      link.download = 'modified_image.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  </script>
</body>
</html>
